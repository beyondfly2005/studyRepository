> 黑马程序员：容器集群管理系统Kubernetes（K8S）从入门到精通
>
> https://www.bilibili.com/video/BV1cK4y1L7Am

## 第一章 Kubernetes介绍

### 1.1 应用部署方式演变

部署应用的方式上，主要经历了三个时代

- **传统部署：**互联网早期 会直接将应用程序部署到物理机上

  优点：简单，不需要其他技术的参与

  缺点：不能为应用程序定义资源使用的边界，很难合理的分配计算资源，二期程序之间容易产生影响

- **容器化部署：**可以在一台物理机上运行多个虚拟机，每个虚拟机都是独立的一个环境

  优点：程序环境不会相互影响，提供了一定程度的安全性

  缺点：增加了操作系统，浪费了部分资源

- **容器化部署：**与虚拟化类似，但是共享了操作系统

  优点：可以保证每个容器拥有自己的文件系统，CPU 内存、进程空间等

  ​			运行应用程序所需的资源都被容器包装，冰河底层基础框架解耦

  ​			容器化的应用程序可以跨云服务商，跨Linux操作系统发行版进行部署



容器化部署地方时带来了许多的便利，但是也可以出现一些问题，比如说：

- 一个容器故障停机了，怎么让另一个容器like启动区替代停机的容器
- 当并发量变大的时候，怎样让做到横向扩展容器的数量
- 当并发量降低时，如何缩减容器数量

容器能力问题 统称为 **容器编排**问题，为了解决容器编排问题，就产生了一些容器编排的软件

- **Docker Swarm：**Docker自己的容器编排工具
- **Mesos：**Apache的一个自由统一管理的工具，需要和Marathon结合使用
- **Kubernetes：** Google开源的容器编排工具

Kubernetes市场占有率77% OpenShift Rancher 是基于Kubernetes开发的



### 1.2 Kubernetes简介

kubernets 是一个全新的基于容器技术的分布式架构领先方案，是谷歌严格保密十几年的秘密武器，—Borg系统的一个开源版本，于2014年9月发布第一个版本，2015年7月发布第一个正式版本

Kubernets的本质是**一组服务器集群**，他可以在集群的每个节点上运行特定的容器，来对节点中的容器进行管理，它的目的就是实现资源管理的自动哈，主要提供了如下主要功能：

- **自我修复**
- **弹性伸缩**：可以根据需要，自动对集群中正在运行的容器数量进行调整
- **服务发现**：服务可以通过自动发现的形式找到它所依赖的服务
- **负载均衡：**如果一个服务启动了多个容器，能够自动实现请求的负载均衡
- **版本回退：**如果发现新发布的程序版本有问题，可以立即回退到原来的版本
- **存储编排：**可以根据容器自身的需求自动创建存储卷

#### 1.3 Kubernetes组件

一个Kubernets集群主要由 **控制节点(master) ** **工作节点(Node)**构成，每个节点上都会安装不同的组件。

**Master：集群的控制平面，负载集群的决策（负载管理）**

**ApiServer：**资源操作的唯一入口，接收用户输入的命令，提供认证、授权、API注册和发现等机制

**Scheduler：**负载集群资源调度，按照预定义的调度策略将Pod调度到响应的node节点上

**ControllerManager：**负责维护集群的状态，比如程序部署安排、故障检测、自动扩展、滚动更新等

**Etcd：**负载存储集群中各个资源对象的信息

**Node：集群的数据平面，负载为容器提供运行环境 （负责工作）**

**Kubelet：**负载维护容器的生命周期，即通过控制docker，来创建、更新、销毁容器

**KubeProxy：**负载提供集群内部的服务发现和负载均衡

**Docker：**负载节点上容器的各种操作

下面，以部署一个nginx服务来说明kubernetes系统各个组件调用关系

1、首先要明确，一旦kubernets环境启动之后，master和node都会讲自身的信息存储到etcd数据库中

2、一个Nginx服务的安装请求会首先被发送到Master节点的APIServer组件

3、ApiServer组件会调用Scheuuler组件来决定到底应该把这个服务安装到那个Node节点上。在此时，他会从etcd中读取各个Node节点的信息，然后安装一定的算法进行选择，并将结果告知APIServer

4、ApiServer调用Controller-Manager去调度Node节点安装Nginx服务

5、Kubelet接收到指令后，会通知Dokcer，然后由Docker来启动一个Nginx的Pod

​	Pod是Kubernets的最小操作单元，容器必须运行在Pod中，至此，一个Nginx服务就运行了

6、如果需要访问Nginx，就需要通过kube-proxy来对pod产生访问的代理，这样，外键用户就可以访问集群中的Nginx服务了

### 1.4 Kubernets相关的概念

- **Master： **集群的控制节点，每个进取至少需要一个master接地那负责集群的管控
- **Node：**工作负载节点，由Master分配容器到这些Node工作节点上，然后Node节点上的Docker负载容器的运行
- **Pod：**是Kubernets的最小控制单元，容器都是运行在Pod中的，一个Pod可以有一个或多个容器
- **Controller：**控制器，通过它来对Pod的管理，比如启动Pod、停止Pod、伸缩Pod数量等待
- **Service：**Pod对外服务的统一入口，在它下面，可以维护着同一类Pod
- **Label：**标签，用于对Pod进行分类管理，同意了Pod会拥有相同的标签
- **NameSpace：**命名空间，用来隔离Pod的运行环境



#### 第二章 集群环境搭建 

本章介绍如何搭建Kubernets的集群环境

### 2.1 环境规划

#### 2.1.1 集群类型

Kubernets集群答题上分为两类：一主多从和多主多从

- 一主多从：一台Master节点和多台Node节点，搭建简单，但是有单机故障风险，适合测试环境
- 多主多从：多台Master节点和多台Node节点，搭建麻烦，安全姓高，适合用于生产环境

> 为了测试简单，本次搭建的是 一主两从 类型的集群



#### 2.2.2 安装方式

Kubernets有多重部署方式 ，目前主流的方式有Kubeadm、MiniKube 、二进制包

- Minikube： 一个用于快速搭建单节点Kubernets的工具
- Kubeadm：一个用于快速搭建Kubernets集群的工具
- 二进制包：从官网下载每个组件的二进制包，依次去安装，此方式对于理解Kubernets组件更加邮箱

> 说明：现在需要安装Kubernets的集群环境，但是又不想过于麻烦，所以选择使用kubeadm方式

#### 2.1.3 主机规划

| 作用   | IP地址        | 操作系统                 | 配置                  |
| ------ | ------------- | ------------------------ | --------------------- |
| Master | 192.168.0.100 | CentOS7.5 基础设施服务器 | 2颗CPU 2G内存 50G硬盘 |
| Node1  | 192.168.0.101 | CentOS7.5 基础设施服务器 | 2颗CPU 2G内存 50G硬盘 |
| Node2  | 192.168.0.102 | CentOS7.5 基础设施服务器 | 2颗CPU 2G内存 50G硬盘 |


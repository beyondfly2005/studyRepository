> https://www.bilibili.com/video/BV1Z4411n74t

# SIP协议

SIP协议和消息结构

SIP即 会话初始协议，用于建立、更改和终止一个或多个参与者的多媒体会话

SIP协议是一个IP网上的呼叫控制协议，在TCP/IP五层模型中位于应用层

与RTP、SDP、RSVP等协议配合共同完成多媒体会话过程

# SIP协议实体

SIP协议在网络中的实体主要分为两大类：SIP用户代理和SIP网络服务器

**SIP用户代理** 用于和用户打交道，发送SIP请求或者接受请求并对其进行处理，接入设备AG主要程度用户代理的作用

**SIP网络服务器** 主要进行请求转发或响应，接受注册请求或提供定位服务，软交换或IMS网络主要承担这样的角色

# SIP消息的结构

## SIP消息的类型

SIP消息分为**请求消息**和**响应消息**两种类型

**请求消息**——指客户端发给服务器的SIP消息，实例消息1即为INVITE请求消息

**响应消息**——用于对请求消息进行响应，指示呼叫的成功或失败的状态

## SIP消息的结构

SIP消息分为：起始行 消息头 消息体

### 起始行

#### 请求消息的起始行

请求消息的起始行由三部分组成

##### 1-方法

方法包括 INVITE ACK OPTIONS BYE CANCEL REGISTER PRACK UPDATE等

| 请求消息类型 | 意义                                                         |
| ------------ | ------------------------------------------------------------ |
| INVITE       | 用于<span style="color:red">邀请</span>用户加入一个呼叫      |
| ACK          | 对请求消息的响应消息进行<span style="color:red">确认</span>  |
| OPTIONS      | 用于<span style="color:red">查询</span>请求能力的消息        |
| BYE          | 用于<span style="color:red">释放</span>已建立的呼叫          |
| CANCEL       | 用于<span style="color:red">释放</span>尚未建立的呼叫        |
| REGISTER     | 用于向SIP网络服务器<span style="color:red">登记</span>用户位置信息 |
| PRACK        | 用于<span style="color:red">确认</span>可靠临时响应          |
| UPDATE       | 用于<span style="color:red">刷新</span>会话                  |

方法决定了请求消息的类型和目的，故请求消息也包含了上述几种类型

##### 2-请求URI 

请求URI 标识请求所用到的用户或服务器地址

```
sip:example.huawei.com
```

##### 3-协议版本 

协议版本：当前使用的SIP版本

示例：

```bash
INVITE sip:example.huawei.com SIP/2.0
```

- INVITE 请求类型
- sip:example.huawei.com 请求URI
- SIP/2.0 请求的协议和版本号

#### 响应消息的起始行

响应消息和请求消息的不同之处仅在于起始行，响应消息起始行也叫状态行，也由三部分组成

```
SIP/2.0 200 OK
```

##### 1-协议版本

- SIP/2.0 协议版本 ：当前使用的SIP版本

##### 2-状态码

- 200 状态码：决定响应消息的类型和目的，它包含三位整数，第一用于定义响应类型，另外两位进一步对响应进行详细说明

  | 状态码 | 含义         | 消息功能                                                     |
  | ------ | ------------ | ------------------------------------------------------------ |
  | 1xx    | 临时响应     | 表示已经接受到请求消息，正在对其进行处理                     |
  | 2xx    | 成功响应     | 表示请求已经被接收，处理并成功接受。                         |
  | 3xx    | 重定向响应   | 表示未完成请求消息需要进一步的行动                           |
  | 4xx    | 客户出错     | 表示请求消息中包含语法错误或者SIP服务器不能完成对该请求消息的处理 |
  | 5xx    | 服务器器出错 | 表示SIP付素琴故障不能完成对正确消息的处理                    |
  | 6xx    | 全局故障     | 表示请求不能再任何SIP服务器上实现                            |

##### 3-原因码

 - OK 原因码：是对状态码的尖端的说明

### 消息头
消息头和消息体对于请求或响应消息来说结构是相似的

SIP消息头主要由SIP头域构成，完成SIP会话过程中信息的传递和部分参数的协商功能

SIP头域在RFC3261标准中有详细描述，这里仅介绍几个经常出现在SIP消息中的头域

- Call-ID：用于唯一标识一次会话，Call-ID需要全局唯一
- From：用于指明请求发起放的地址，服务器会将此字段从请求消息复制到对应的响应消息中
- To：用于标识请求的接收者
- CSeq：用于标识请求的序列号，客户端在每个请求中加入此字段，服务器将请求中的CSeq复制到响应消息中，其作用是判断响应和请求的对应关系。



### 消息体

消息体：主要用于会话建立过程中会话信息和参数的协商，此外还要完成认证和鉴权信息的传送。

一般来说,SIP的消息体为SDP格式



